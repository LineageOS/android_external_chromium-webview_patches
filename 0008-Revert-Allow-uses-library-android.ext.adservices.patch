From 4bbe2c658a845ea2233e4dd6f11cc2a4621a1441 Mon Sep 17 00:00:00 2001
From: "Kevin F. Haggerty" <haggertk@lineageos.org>
Date: Sat, 2 Mar 2024 08:55:45 -0700
Subject: [PATCH 08/12] Revert "Allow uses-library android.ext.adservices"

This reverts commit 0c3ae92dd16b763625a4d8c3f05012d9813dee2d.
---
 ...view_32_64_bundle.AndroidManifest.expected |  1 -
 ...webview_32_bundle.AndroidManifest.expected |  1 -
 ...view_64_32_bundle.AndroidManifest.expected |  1 -
 ...webview_64_bundle.AndroidManifest.expected |  1 -
 ...em_webview_bundle.AndroidManifest.expected |  1 -
 ...view_32_64_bundle.AndroidManifest.expected |  1 -
 ...webview_32_bundle.AndroidManifest.expected |  1 -
 ...view_64_32_bundle.AndroidManifest.expected |  1 -
 ...webview_64_bundle.AndroidManifest.expected |  1 -
 ...me_webview_bundle.AndroidManifest.expected |  1 -
 .../0_privacysandbox_AndroidManifest.xml      | 19 +++++++++++++++++++
 third_party/androidx/customizations.gni       |  6 ++++++
 12 files changed, 25 insertions(+), 10 deletions(-)
 create mode 100644 third_party/androidx/0_privacysandbox_AndroidManifest.xml

diff --git a/android_webview/expectations/system_webview_32_64_bundle.AndroidManifest.expected b/android_webview/expectations/system_webview_32_64_bundle.AndroidManifest.expected
index ca072e61ee689..ce8dfe792259b 100644
--- a/android_webview/expectations/system_webview_32_64_bundle.AndroidManifest.expected
+++ b/android_webview/expectations/system_webview_32_64_bundle.AndroidManifest.expected
@@ -509,7 +509,6 @@
         android:process=":sandboxed_process9"
         android:visibleToInstantApps="true">
     </service>  # DIFF-ANCHOR: e2f3bbbd
-    <uses-library android:name="android.ext.adservices" android:required="false"/>
     <uses-library android:name="android.test.base" android:required="false"/>
     <uses-library android:name="androidx.window.extensions" android:required="false"/>
   </application>
diff --git a/android_webview/expectations/system_webview_32_bundle.AndroidManifest.expected b/android_webview/expectations/system_webview_32_bundle.AndroidManifest.expected
index 359a3c539d65c..d0d36cd75da1f 100644
--- a/android_webview/expectations/system_webview_32_bundle.AndroidManifest.expected
+++ b/android_webview/expectations/system_webview_32_bundle.AndroidManifest.expected
@@ -508,7 +508,6 @@
         android:process=":sandboxed_process9"
         android:visibleToInstantApps="true">
     </service>  # DIFF-ANCHOR: e2f3bbbd
-    <uses-library android:name="android.ext.adservices" android:required="false"/>
     <uses-library android:name="android.test.base" android:required="false"/>
     <uses-library android:name="androidx.window.extensions" android:required="false"/>
   </application>
diff --git a/android_webview/expectations/system_webview_64_32_bundle.AndroidManifest.expected b/android_webview/expectations/system_webview_64_32_bundle.AndroidManifest.expected
index a6b568486d3f1..72ac6f25bdb38 100644
--- a/android_webview/expectations/system_webview_64_32_bundle.AndroidManifest.expected
+++ b/android_webview/expectations/system_webview_64_32_bundle.AndroidManifest.expected
@@ -508,7 +508,6 @@
         android:process=":sandboxed_process9"
         android:visibleToInstantApps="true">
     </service>  # DIFF-ANCHOR: e2f3bbbd
-    <uses-library android:name="android.ext.adservices" android:required="false"/>
     <uses-library android:name="android.test.base" android:required="false"/>
     <uses-library android:name="androidx.window.extensions" android:required="false"/>
   </application>
diff --git a/android_webview/expectations/system_webview_64_bundle.AndroidManifest.expected b/android_webview/expectations/system_webview_64_bundle.AndroidManifest.expected
index 5859daad6936c..56fb6fc00f9e3 100644
--- a/android_webview/expectations/system_webview_64_bundle.AndroidManifest.expected
+++ b/android_webview/expectations/system_webview_64_bundle.AndroidManifest.expected
@@ -508,7 +508,6 @@
         android:process=":sandboxed_process9"
         android:visibleToInstantApps="true">
     </service>  # DIFF-ANCHOR: e2f3bbbd
-    <uses-library android:name="android.ext.adservices" android:required="false"/>
     <uses-library android:name="android.test.base" android:required="false"/>
     <uses-library android:name="androidx.window.extensions" android:required="false"/>
   </application>
diff --git a/android_webview/expectations/system_webview_bundle.AndroidManifest.expected b/android_webview/expectations/system_webview_bundle.AndroidManifest.expected
index 41a26c8ba9e66..39261ba5fc662 100644
--- a/android_webview/expectations/system_webview_bundle.AndroidManifest.expected
+++ b/android_webview/expectations/system_webview_bundle.AndroidManifest.expected
@@ -497,6 +497,5 @@
         android:process=":sandboxed_process9"
         android:visibleToInstantApps="true">
     </service>  # DIFF-ANCHOR: e2f3bbbd
-    <uses-library android:name="android.ext.adservices" android:required="false"/>
   </application>
 </manifest>
diff --git a/android_webview/expectations/trichrome_webview_32_64_bundle.AndroidManifest.expected b/android_webview/expectations/trichrome_webview_32_64_bundle.AndroidManifest.expected
index 0412da609d380..d8d27ed36c186 100644
--- a/android_webview/expectations/trichrome_webview_32_64_bundle.AndroidManifest.expected
+++ b/android_webview/expectations/trichrome_webview_32_64_bundle.AndroidManifest.expected
@@ -508,7 +508,6 @@
         android:process=":sandboxed_process9"
         android:visibleToInstantApps="true">
     </service>  # DIFF-ANCHOR: e2f3bbbd
-    <uses-library android:name="android.ext.adservices" android:required="false"/>
     <uses-library android:name="androidx.window.extensions" android:required="false"/>
     <uses-static-library android:name="org.chromium.trichromelibrary" android:certDigest="32a2fc74d731105859e5a85df16d95f102d85b22099b8064c5d8915c61dad1e0" android:version="OFFSET=31"/>
   </application>
diff --git a/android_webview/expectations/trichrome_webview_32_bundle.AndroidManifest.expected b/android_webview/expectations/trichrome_webview_32_bundle.AndroidManifest.expected
index c2208400206c0..919b3a5ffcc0f 100644
--- a/android_webview/expectations/trichrome_webview_32_bundle.AndroidManifest.expected
+++ b/android_webview/expectations/trichrome_webview_32_bundle.AndroidManifest.expected
@@ -507,7 +507,6 @@
         android:process=":sandboxed_process9"
         android:visibleToInstantApps="true">
     </service>  # DIFF-ANCHOR: e2f3bbbd
-    <uses-library android:name="android.ext.adservices" android:required="false"/>
     <uses-library android:name="androidx.window.extensions" android:required="false"/>
     <uses-static-library android:name="org.chromium.trichromelibrary" android:certDigest="32a2fc74d731105859e5a85df16d95f102d85b22099b8064c5d8915c61dad1e0" android:version="OFFSET=30"/>
   </application>
diff --git a/android_webview/expectations/trichrome_webview_64_32_bundle.AndroidManifest.expected b/android_webview/expectations/trichrome_webview_64_32_bundle.AndroidManifest.expected
index 7dc832d57d4d7..28708e306df1d 100644
--- a/android_webview/expectations/trichrome_webview_64_32_bundle.AndroidManifest.expected
+++ b/android_webview/expectations/trichrome_webview_64_32_bundle.AndroidManifest.expected
@@ -507,7 +507,6 @@
         android:process=":sandboxed_process9"
         android:visibleToInstantApps="true">
     </service>  # DIFF-ANCHOR: e2f3bbbd
-    <uses-library android:name="android.ext.adservices" android:required="false"/>
     <uses-library android:name="androidx.window.extensions" android:required="false"/>
     <uses-static-library android:name="org.chromium.trichromelibrary" android:certDigest="32a2fc74d731105859e5a85df16d95f102d85b22099b8064c5d8915c61dad1e0" android:version="OFFSET=33"/>
   </application>
diff --git a/android_webview/expectations/trichrome_webview_64_bundle.AndroidManifest.expected b/android_webview/expectations/trichrome_webview_64_bundle.AndroidManifest.expected
index 7fc1bab963334..f472084db1d42 100644
--- a/android_webview/expectations/trichrome_webview_64_bundle.AndroidManifest.expected
+++ b/android_webview/expectations/trichrome_webview_64_bundle.AndroidManifest.expected
@@ -507,7 +507,6 @@
         android:process=":sandboxed_process9"
         android:visibleToInstantApps="true">
     </service>  # DIFF-ANCHOR: e2f3bbbd
-    <uses-library android:name="android.ext.adservices" android:required="false"/>
     <uses-library android:name="androidx.window.extensions" android:required="false"/>
     <uses-static-library android:name="org.chromium.trichromelibrary" android:certDigest="32a2fc74d731105859e5a85df16d95f102d85b22099b8064c5d8915c61dad1e0" android:version="OFFSET=34"/>
   </application>
diff --git a/android_webview/expectations/trichrome_webview_bundle.AndroidManifest.expected b/android_webview/expectations/trichrome_webview_bundle.AndroidManifest.expected
index d873ece60663a..bcd903033aaa5 100644
--- a/android_webview/expectations/trichrome_webview_bundle.AndroidManifest.expected
+++ b/android_webview/expectations/trichrome_webview_bundle.AndroidManifest.expected
@@ -497,7 +497,6 @@
         android:process=":sandboxed_process9"
         android:visibleToInstantApps="true">
     </service>  # DIFF-ANCHOR: e2f3bbbd
-    <uses-library android:name="android.ext.adservices" android:required="false"/>
     <uses-static-library android:name="org.chromium.trichromelibrary" android:certDigest="32a2fc74d731105859e5a85df16d95f102d85b22099b8064c5d8915c61dad1e0" android:version="OFFSET=31"/>
   </application>
 </manifest>
diff --git a/third_party/androidx/0_privacysandbox_AndroidManifest.xml b/third_party/androidx/0_privacysandbox_AndroidManifest.xml
new file mode 100644
index 0000000000000..da6c78ff7b0cc
--- /dev/null
+++ b/third_party/androidx/0_privacysandbox_AndroidManifest.xml
@@ -0,0 +1,19 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!--
+Copyright 2023 The Chromium Authors
+Use of this source code is governed by a BSD-style license that can be
+found in the LICENSE file.
+-->
+<manifest xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:tools="http://schemas.android.com/tools"
+    package="org.chromium.privacysandbox.overrides">
+
+    <!-- Library needed for androidx.privacysandbox.ads:ads-adservices to work on Android R & S,
+      which we do not currently support. Removing out of caution to prevent the library from
+      slowing down renderer process start-up.
+      https://crbug.com/1448095
+    -->
+    <application>
+      <uses-library android:name="android.ext.adservices" tools:node="remove" />
+    </application>
+</manifest>
diff --git a/third_party/androidx/customizations.gni b/third_party/androidx/customizations.gni
index fe3d1088a102e..036b119594aa1 100644
--- a/third_party/androidx/customizations.gni
+++ b/third_party/androidx/customizations.gni
@@ -79,6 +79,12 @@ template("_androidx_prebuilt") {
       # Replace broad library -keep rules with a more limited set in
       # chrome/android/java/proguard.flags instead.
       ignore_proguard_configs = true
+    } else if (target_name ==
+               "androidx_privacysandbox_ads_ads_adservices_java") {
+      if (!is_high_end_android) {
+        # https://crbug.com/1448095
+        mergeable_android_manifests = [ "0_privacysandbox_AndroidManifest.xml" ]
+      }
     } else if (target_name == "androidx_startup_startup_runtime_java") {
       # Keeps emoji2 code. See http://crbug.com/1205141
       ignore_proguard_configs = true
-- 
2.52.0

